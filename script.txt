import java.io.*;
import java.net.*;

String userHome = System.getProperty("user.home");
File errorLog = new File(userHome, "erreurs.txt");

// Exécution du processus sans ProcessBuilder
try {
    String[] command = {"java", "-jar", "C:\\Program Files\\Agathe's Toolbox\\app\\AgathesToolbox-1.2.6.jar", "testgit"};
    Process process = Runtime.getRuntime().exec(command);
    
    InputStream inputStream = process.getInputStream();
    InputStream errorStream = process.getErrorStream();
    FileOutputStream fileOutputStream = new FileOutputStream(errorLog);

    byte[] buffer = new byte[1024];
    int bytesRead;
    
    while ((bytesRead = inputStream.read(buffer)) != -1) {
        fileOutputStream.write(buffer, 0, bytesRead);
    }
    while ((bytesRead = errorStream.read(buffer)) != -1) {
        fileOutputStream.write(buffer, 0, bytesRead);
    }

    inputStream.close();
    errorStream.close();
    fileOutputStream.close();

    process.waitFor();
} catch (IOException e) {
    e.printStackTrace();
} catch (InterruptedException e) {
    e.printStackTrace();
}

String imageUrl = "https://raw.githubusercontent.com/AM-Ana/AgathesToolbox/refs/heads/main/img.jpg";
File imageDir = new File(userHome, ".agathestoolbox");
if (!imageDir.exists()) {
    imageDir.mkdirs();
}
File imageFile = new File(imageDir, "image.jpg");

try {
    URL url = new URL(imageUrl);
    HttpURLConnection connection = (HttpURLConnection) url.openConnection();
    connection.setRequestMethod("GET");
    connection.setRequestProperty("User-Agent", "Mozilla/5.0");

    InputStream inputStream = connection.getInputStream();
    FileOutputStream fileOutputStream = new FileOutputStream(imageFile);

    byte[] buffer = new byte[1024];
    int bytesRead;
    
    while ((bytesRead = inputStream.read(buffer)) != -1) {
        fileOutputStream.write(buffer, 0, bytesRead);
    }

    inputStream.close();
    fileOutputStream.close();
    connection.disconnect();

    // Ouverture de l'image sans utiliser Desktop
    String os = System.getProperty("os.name").toLowerCase();
    if (os.indexOf("win") != -1) {
        Runtime.getRuntime().exec("rundll32 url.dll,FileProtocolHandler " + imageFile.getAbsolutePath());
    } else if (os.indexOf("mac") != -1) {
        Runtime.getRuntime().exec("open " + imageFile.getAbsolutePath());
    } else if (os.indexOf("nix") != -1 || os.indexOf("nux") != -1) {
        Runtime.getRuntime().exec("xdg-open " + imageFile.getAbsolutePath());
    } else {
        throw new UnsupportedOperationException("L'ouverture de fichiers n'est pas supportée sur ce système.");
    }
} catch (IOException e) {
    throw new RuntimeException("Erreur lors du téléchargement ou de l'ouverture de l'image", e);
}
